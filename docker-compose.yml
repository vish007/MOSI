version: '3.9'
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: mosi
      POSTGRES_PASSWORD: mosi
      POSTGRES_DB: mosi
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  auth-service:
    build:
      context: backend
      dockerfile: Dockerfile
    command: gunicorn -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8001
    environment:
      PYTHONPATH: /app
      SERVICE_NAME: auth-service
      DATABASE_URL: postgresql://mosi:mosi@postgres:5432/mosi
    working_dir: /app/services/auth-service
    ports: ["8001:8001"]
    depends_on: [postgres]

  broker-service:
    build:
      context: backend
      dockerfile: Dockerfile
    command: gunicorn -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8002
    environment:
      PYTHONPATH: /app
      SERVICE_NAME: broker-service
      DATABASE_URL: postgresql://mosi:mosi@postgres:5432/mosi
    working_dir: /app/services/broker-service
    ports: ["8002:8002"]
    depends_on: [postgres]

  portfolio-service:
    build:
      context: backend
      dockerfile: Dockerfile
    command: gunicorn -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8003
    environment:
      PYTHONPATH: /app
      SERVICE_NAME: portfolio-service
      DATABASE_URL: postgresql://mosi:mosi@postgres:5432/mosi
    working_dir: /app/services/portfolio-service
    ports: ["8003:8003"]
    depends_on: [postgres]

  signal-service:
    build:
      context: backend
      dockerfile: Dockerfile
    command: gunicorn -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8004
    environment:
      PYTHONPATH: /app
      SERVICE_NAME: signal-service
      DATABASE_URL: postgresql://mosi:mosi@postgres:5432/mosi
      ML_URL: http://ml-service:8010
    working_dir: /app/services/signal-service
    ports: ["8004:8004"]
    depends_on: [postgres, ml-service]

  feedback-service:
    build:
      context: backend
      dockerfile: Dockerfile
    command: gunicorn -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8005
    environment:
      PYTHONPATH: /app
      SERVICE_NAME: feedback-service
      DATABASE_URL: postgresql://mosi:mosi@postgres:5432/mosi
    working_dir: /app/services/feedback-service
    ports: ["8005:8005"]
    depends_on: [postgres]

  api-gateway:
    build:
      context: backend
      dockerfile: Dockerfile
    command: gunicorn -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8000
    environment:
      PYTHONPATH: /app
      AUTH_URL: http://auth-service:8001
      BROKER_URL: http://broker-service:8002
      PORTFOLIO_URL: http://portfolio-service:8003
      SIGNAL_URL: http://signal-service:8004
      FEEDBACK_URL: http://feedback-service:8005
    working_dir: /app/services/api-gateway
    ports: ["8000:8000"]
    depends_on: [auth-service, broker-service, portfolio-service, signal-service, feedback-service]

  ml-service:
    build:
      context: ml
      dockerfile: Dockerfile
    command: uvicorn app.main:app --host 0.0.0.0 --port 8010
    ports: ["8010:8010"]

volumes:
  pgdata:
